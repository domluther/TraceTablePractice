<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trace Table Practice - Integration Tests</title>
    <link rel="stylesheet" href="css/test-styles.css">
</head>
<body>
    <div class="container">
        <h1>🔗 Trace Table Practice - Integration Tests</h1>
        
        <div id="testSummary"></div>
        
        <button class="run-tests-btn" onclick="runAllTests()">🔄 Run All Tests</button>
        <button class="toggle-btn" id="togglePassedBtn" onclick="togglePassedTests()" title="Toggle passed tests visibility (Shortcut: H key)">👁️ Show Passed Tests</button>
        
        <div id="testResults"></div>
    </div>

    <script type="module">
        // ============================================================================
        // INTEGRATION TESTS - SCOPE AND PURPOSE
        // ============================================================================
        /*
         * These integration tests focus on complete program execution scenarios.
         * They test how all components work together in real-world GCSE Computer
         * Science program contexts, validating full workflows from input to output.
         * 
         * INTEGRATION TEST SCOPE:
         * - Complete GCSE program scenarios with realistic inputs
         * - End-to-end trace table validation (line-by-line execution tracking)
         * - Input/output integration patterns
         * - Multi-feature interactions in complete programs
         * - Real-world problem solving contexts (shopping, calculation, etc.)
         * - Complex program flow with conditionals, loops, and user interaction
         * 
         * DESIGN PRINCIPLES:
         * - Each test represents a complete, realistic program scenario
         * - Programs demonstrate typical GCSE Computer Science patterns
         * - Comprehensive validation of execution flow and outputs
         * - Clear separation from unit tests (no isolated feature testing)
         * - Focus on system behavior rather than individual methods
         * 
         * For individual feature testing, see tests.html
         */
        
        // ============================================================================
        // TEST FRAMEWORK AND UTILITIES
        // ============================================================================
        
        // Import the actual production Interpreter class
        import { Interpreter } from './js/interpreter.js';
        
        // Test state management
        let testResults = [];
        let testsPassed = 0;
        let testsFailed = 0;
        
        /**
         * Core assertion function for integration testing
         * @param {boolean} condition - The condition to test
         * @param {string} testName - Descriptive name of the test
         * @param {string} details - Additional diagnostic information
         */
        function assert(condition, testName, details = '') {
            if (condition) {
                testResults.push({
                    name: testName,
                    passed: true,
                    details: details
                });
                testsPassed++;
            } else {
                testResults.push({
                    name: testName,
                    passed: false,
                    details: details
                });
                testsFailed++;
            }
        }
        
        /**
         * Equality assertion with detailed failure reporting
         * @param {any} actual - The actual value produced
         * @param {any} expected - The expected value
         * @param {string} testName - Descriptive name of the test
         * @param {string} details - Additional context
         */
        function assertEqual(actual, expected, testName, details = '') {
            const condition = actual === expected;
            const testDetails = details + ` (Expected: ${expected}, Got: ${actual})`;
            assert(condition, testName, testDetails);
        }
        
        /**
         * Array equality assertion for comprehensive comparisons
         * @param {Array} actual - The actual array produced
         * @param {Array} expected - The expected array
         * @param {string} testName - Descriptive name of the test
         * @param {string} details - Additional context
         */
        function assertArrayEqual(actual, expected, testName, details = '') {
            const condition = JSON.stringify(actual) === JSON.stringify(expected);
            const testDetails = details + ` (Expected: ${JSON.stringify(expected)}, Got: ${JSON.stringify(actual)})`;
            assert(condition, testName, testDetails);
        }
        
        // ============================================================================
        // ARITHMETIC AND CALCULATION PROGRAMS
        // ============================================================================
        
        /**
         * Test basic calculator program with multiple operations
         * Covers: arithmetic operations, input handling, conditional logic
         */
        function testCalculatorProgram() {
            const testInterpreter = new Interpreter();
            const calculatorProgram = { 
                inputs: ["15", "4", "1"], 
                randomValue: undefined 
            };
            
            const result = testInterpreter.executeProgram(`
                a = int(input("Enter first number"))
                b = int(input("Enter second number"))
                operation = int(input("Enter operation (1=add, 2=subtract, 3=multiply, 4=divide)"))
                
                if operation == 1 then
                    result = a + b
                    print("Sum: " + result)
                elseif operation == 2 then
                    result = a - b
                    print("Difference: " + result)
                elseif operation == 3 then
                    result = a * b
                    print("Product: " + result)
                elseif operation == 4 then
                    if b != 0 then
                        result = a / b
                        print("Quotient: " + result)
                    else
                        print("Cannot divide by zero")
                    endif
                else
                    print("Invalid operation")
                endif
            `, calculatorProgram);
            
            // Test variables
            assertEqual(testInterpreter.variables.a, 15, 'Calculator: First number should be 15');
            assertEqual(testInterpreter.variables.b, 4, 'Calculator: Second number should be 4'); 
            assertEqual(testInterpreter.variables.operation, 1, 'Calculator: Operation should be 1 (add)');
            assertEqual(testInterpreter.variables.result, 19, 'Calculator: Result should be 19 (15 + 4)');
            
            // Test output
            assertEqual(testInterpreter.outputs.length, 1, 'Calculator: Should have 1 output');
            assertEqual(testInterpreter.outputs[0], 'Sum: 19', 'Calculator: Output should be "Sum: 19"');
            
            // Test trace table structure (should trace inputs,  calculation, output)
            assert(testInterpreter.trace.length >= 5, 'Calculator: Should have at least 5 trace entries');
        }
        
        // ============================================================================
        // CONDITIONAL LOGIC PROGRAMS
        // ============================================================================
        
        /**
         * Test grade classification program with multiple conditional branches
         * Covers: nested conditionals, input validation, string output
         */
        function testGradeClassification() {
            const testInterpreter = new Interpreter();
            const gradeProgram = { 
                inputs: ["87"], 
                randomValue: undefined 
            };
            
            const result = testInterpreter.executeProgram(`
                score = int(input("Enter exam score"))
                
                if score >= 90 then
                    grade = "A"
                elseif score >= 80 then
                    grade = "B"
                elseif score >= 70 then
                    grade = "C"
                elseif score >= 60 then
                    grade = "D"
                else
                    grade = "F"
                endif
                
                print("Score: " + score + " Grade: " + grade)
            `, gradeProgram);
            
            // Test variables
            assertEqual(testInterpreter.variables.score, 87, 'Grade: Score should be 87');
            assertEqual(testInterpreter.variables.grade, 'B', 'Grade: Grade should be B (80-89 range)');
            
            // Test output
            assertEqual(testInterpreter.outputs[0], 'Score: 87 Grade: B', 'Grade: Output should show score and grade');
        }
        
        // ============================================================================
        // LOOP-BASED PROGRAMS
        // ============================================================================
        
        /**
         * Test multiplication table generator
         * Covers: for loops, arithmetic in loops, formatted output
         */
        function testMultiplicationTable() {
            const testInterpreter = new Interpreter();
            const tableProgram = { 
                inputs: ["5"], 
                randomValue: undefined 
            };
            
            const result = testInterpreter.executeProgram(`
                number = int(input("Enter number for table"))
                
                for i = 1 to 5
                    result = number * i
                    print(number + " x " + i + " = " + result)
                next i
            `, tableProgram);
            
            // Test variables
            assertEqual(testInterpreter.variables.number, 5, 'Table: Number should be 5');
            assertEqual(testInterpreter.variables.i, 5, 'Table: Loop variable should end at 5');
            
            // Test outputs (should have 5 multiplication results)
            assertEqual(testInterpreter.outputs.length, 5, 'Table: Should have 5 outputs');
            assertEqual(testInterpreter.outputs[0], '5 x 1 = 5', 'Table: First line should be "5 x 1 = 5"');
            assertEqual(testInterpreter.outputs[4], '5 x 5 = 25', 'Table: Last line should be "5 x 5 = 25"');
        }
        
        // ============================================================================
        // STRING PROCESSING PROGRAMS
        // ============================================================================
        
        /**
         * Test name processing with string methods
         * Covers: string input, string methods, conditional string processing
         */
        function testNameProcessor() {
            const testInterpreter = new Interpreter();
            const nameProgram = { 
                inputs: ["John", "Smith"], 
                randomValue: undefined 
            };
            
            const result = testInterpreter.executeProgram(`
                firstName = input("Enter first name")
                lastName = input("Enter last name")
                
                initials = firstName.left(1) + lastName.left(1)
                fullName = firstName + " " + lastName
                nameLength = fullName.length
                
                print("Full name: " + fullName)
                print("Initials: " + initials)
                print("Length: " + nameLength)
                
                if nameLength > 10 then
                    print("Long name")
                else
                    print("Short name")
                endif
            `, nameProgram);
            
            // Test variables
            assertEqual(testInterpreter.variables.firstName, 'John', 'Name: First name should be John');
            assertEqual(testInterpreter.variables.lastName, 'Smith', 'Name: Last name should be Smith');
            assertEqual(testInterpreter.variables.initials, 'JS', 'Name: Initials should be JS');
            assertEqual(testInterpreter.variables.fullName, 'John Smith', 'Name: Full name should be "John Smith"');
            assertEqual(testInterpreter.variables.nameLength, 10, 'Name: Length should be 10');
            
            // Test outputs
            assertEqual(testInterpreter.outputs.length, 4, 'Name: Should have 4 outputs');
            assertEqual(testInterpreter.outputs[0], 'Full name: John Smith', 'Name: First output should show full name');
            assertEqual(testInterpreter.outputs[1], 'Initials: JS', 'Name: Second output should show initials');
            assertEqual(testInterpreter.outputs[2], 'Length: 10', 'Name: Third output should show length');
            assertEqual(testInterpreter.outputs[3], 'Short name', 'Name: Fourth output should show "Short name"');
        }
        
        // ============================================================================
        // ARRAY PROCESSING PROGRAMS
        // ============================================================================
        
        /**
         * Test shopping cart total calculator
         * Covers: arrays, loops with arrays, running totals
         */
        function testShoppingCart() {
            const testInterpreter = new Interpreter();
            
            const shoppingProgram = { 
                inputs: [], 
                randomValue: undefined 
            };
            
            const result = testInterpreter.executeProgram(`
                prices = [12.99, 8.50, 15.75, 22.00]
                total = 0
                
                for i = 0 to 3
                    total = total + prices[i]
                    print("Item " + (i + 1) + ": $" + prices[i])
                next i
                
                print("Total: $" + total)
            `, shoppingProgram);
            
            // Test variables
            assertEqual(testInterpreter.variables.total, 59.24, 'Shopping: Total should be 59.24');
            assertEqual(testInterpreter.variables.i, 3, 'Shopping: Loop variable should end at 3');
            
            // Test outputs
            assertEqual(testInterpreter.outputs.length, 5, 'Shopping: Should have 5 outputs (4 items + total)');
            assertEqual(testInterpreter.outputs[0], 'Item 1: $12.99', 'Shopping: First item output');
            assertEqual(testInterpreter.outputs[4], 'Total: $59.24', 'Shopping: Total output');
        }
        
        // ============================================================================
        // COMPLEX NESTED PROGRAMS
        // ============================================================================
        
        /**
         * Test student grade analyzer with multiple features
         * Covers: nested conditionals, loops, arrays, string processing, calculations
         */
        function testStudentGradeAnalyzer() {
            const testInterpreter = new Interpreter();
            const gradeAnalyzer = { 
                inputs: ["Alice", "85", "92", "78"], 
                randomValue: undefined 
            };
            
            const result = testInterpreter.executeProgram(`
                name = input("Enter student name")
                
                scores = []
                total = 0
                
                for i = 0 to 2
                    score = int(input("Enter score " + (i + 1)))
                    scores[i] = score
                    total = total + score
                next i
                
                average = total / 3
                
                if average >= 90 then
                    grade = "A"
                elseif average >= 80 then
                    grade = "B"
                elseif average >= 70 then
                    grade = "C"
                else
                    grade = "F"
                endif
                
                print("Student: " + name)
                print("Scores: " + scores[0] + ", " + scores[1] + ", " + scores[2])
                print("Average: " + average)
                print("Grade: " + grade)
            `, gradeAnalyzer);
            
            // Test variables
            assertEqual(testInterpreter.variables.name, 'Alice', 'Analyzer: Name should be Alice');
            assertEqual(testInterpreter.variables.total, 255, 'Analyzer: Total should be 255 (85+92+78)');
            assertEqual(Math.round(testInterpreter.variables.average * 100) / 100, 85, 'Analyzer: Average should be 85');
            assertEqual(testInterpreter.variables.grade, 'B', 'Analyzer: Grade should be B');
            
            // Test array
            assertArrayEqual(testInterpreter.variables.scores, [85, 92, 78], 'Analyzer: Scores array should contain [85, 92, 78]');
            
            // Test outputs
            assertEqual(testInterpreter.outputs.length, 4, 'Analyzer: Should have 4 outputs');
            assertEqual(testInterpreter.outputs[0], 'Student: Alice', 'Analyzer: First output should show student name');
            assertEqual(testInterpreter.outputs[1], 'Scores: 85, 92, 78', 'Analyzer: Second output should show scores');
        }
        
        // ============================================================================
        // ADVANCED ALGORITHM PROGRAMS
        // ============================================================================
        
        /**
         * Test number pattern generator with complex logic
         * Covers: nested loops, mathematical patterns, conditional output
         */
        function testNumberPatternGenerator() {
            const testInterpreter = new Interpreter();
            const patternProgram = { 
                inputs: ["4"], 
                randomValue: undefined 
            };
            
            const result = testInterpreter.executeProgram(`
                size = int(input("Enter pattern size"))
                
                for row = 1 to size
                    line = ""
                    
                    for col = 1 to size
                        if col <= row then
                            line = line + "*"
                        else
                            line = line + " "
                        endif
                    next col
                    
                    print(line)
                next row
            `, patternProgram);
            
            // Test variables
            assertEqual(testInterpreter.variables.size, 4, 'Pattern: Size should be 4');
            assertEqual(testInterpreter.variables.row, 4, 'Pattern: Outer loop should end at 4');
            assertEqual(testInterpreter.variables.col, 4, 'Pattern: Inner loop should end at 4');
            
            // Test outputs (should create a triangle pattern)
            assertEqual(testInterpreter.outputs.length, 4, 'Pattern: Should have 4 rows');
            assertEqual(testInterpreter.outputs[0], '*   ', 'Pattern: First row should be "*   "');
            assertEqual(testInterpreter.outputs[1], '**  ', 'Pattern: Second row should be "**  "');
            assertEqual(testInterpreter.outputs[2], '*** ', 'Pattern: Third row should be "*** "');
            assertEqual(testInterpreter.outputs[3], '****', 'Pattern: Fourth row should be "****"');
        }
        
        // ============================================================================
        // TEST MANAGEMENT AND EXECUTION
        // ============================================================================
        
        /**
         * Reset test state for a fresh test run
         */
        function resetTestState() {
            testResults = [];
            testsPassed = 0;
            testsFailed = 0;
        }
        
        /**
         * Display comprehensive test summary
         */
        function displayTestSummary() {
            const summaryDiv = document.getElementById('testSummary');
            const passRate = testsPassed + testsFailed > 0 ? 
                Math.round((testsPassed / (testsPassed + testsFailed)) * 100) : 0;
            
            summaryDiv.innerHTML = `
                <div class="test-summary ${passRate === 100 ? 'all-pass' : 'has-failures'}">
                    <h2>📊 Integration Test Results</h2>
                    <p><strong>Passed:</strong> ${testsPassed} | <strong>Failed:</strong> ${testsFailed} | <strong>Pass Rate:</strong> ${passRate}%</p>
                    <p><em>Testing complete program scenarios and end-to-end workflows</em></p>
                </div>
            `;
        }
        
        /**
         * Display categorized test results
         */
        function displayTestResults() {
            const resultsDiv = document.getElementById('testResults');
            
            // Group tests by program type
            const testCategories = {
                'Calculator Program': ['Calculator:'],
                'Grade Classification': ['Grade:'],
                'Multiplication Table': ['Table:'],
                'Name Processor': ['Name:'],
                'Shopping Cart': ['Shopping:'],
                'Student Grade Analyzer': ['Analyzer:'],
                'Number Pattern Generator': ['Pattern:']
            };
            
            let html = '';
            
            for (const [categoryName, prefixes] of Object.entries(testCategories)) {
                const categoryTests = testResults.filter(test => 
                    prefixes.some(prefix => test.name.startsWith(prefix))
                );
                
                if (categoryTests.length > 0) {
                    html += `<div class="test-section">`;
                    html += `<h2>${categoryName}</h2>`;
                    
                    for (const test of categoryTests) {
                        const cssClass = test.passed ? 'test-pass' : 'test-fail';
                        const status = test.passed ? '✅ PASS' : '❌ FAIL';
                        html += `<div class="test-result ${cssClass}">`;
                        html += `<strong>${status}</strong> - ${test.name}`;
                        if (test.details) {
                            html += `<div class="test-details">${test.details}</div>`;
                        }
                        html += `</div>`;
                    }
                    
                    html += `</div>`;
                }
            }
            
            resultsDiv.innerHTML = html;
            
            // Default to hiding passed tests (show summary always)
            const container = document.querySelector('.container');
            const toggleBtn = document.getElementById('togglePassedBtn');
            
            container.classList.add('hide-passed');
            const passedCount = document.querySelectorAll('.test-result.test-pass').length;
            toggleBtn.textContent = `👁️ Show Passed Tests (${passedCount} hidden)`;
            toggleBtn.classList.add('active');
            
            displayTestSummary();
        }
        
        /**
         * Toggle visibility of passed tests
         */
        function togglePassedTests() {
            const container = document.querySelector('.container');
            const toggleBtn = document.getElementById('togglePassedBtn');
            const passedCount = document.querySelectorAll('.test-result.test-pass').length;
            
            if (container.classList.contains('hide-passed')) {
                container.classList.remove('hide-passed');
                toggleBtn.textContent = '🙈 Hide Passed Tests';
                toggleBtn.classList.remove('active');
            } else {
                container.classList.add('hide-passed');
                toggleBtn.textContent = `👁️ Show Passed Tests (${passedCount} hidden)`;
                toggleBtn.classList.add('active');
            }
        }
        
        /**
         * Set up keyboard shortcuts for test management
         */
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(event) {
                if (event.key === 'h' || event.key === 'H') {
                    togglePassedTests();
                } else if (event.key === 'r' || event.key === 'R') {
                    runAllTests();
                }
            });
        }
        
        /**
         * Validate test count for debugging purposes
         */
        function validateTestCounts() {
            const expectedTestCount = 45; // Approximate expected total
            const actualTestCount = testResults.length;
            
            if (actualTestCount !== expectedTestCount) {
                console.warn(`⚠️  Test count mismatch: Expected ~${expectedTestCount}, got ${actualTestCount}`);
                console.log('Test categories breakdown:', {
                    'Calculator': testResults.filter(t => t.name.startsWith('Calculator:')).length,
                    'Grade': testResults.filter(t => t.name.startsWith('Grade:')).length,
                    'Table': testResults.filter(t => t.name.startsWith('Table:')).length,
                    'Name': testResults.filter(t => t.name.startsWith('Name:')).length,
                    'Shopping': testResults.filter(t => t.name.startsWith('Shopping:')).length,
                    'Analyzer': testResults.filter(t => t.name.startsWith('Analyzer:')).length,
                    'Pattern': testResults.filter(t => t.name.startsWith('Pattern:')).length
                });
            }
        }
        
        /**
         * Run all integration tests
         */
        function runAllTests() {
            // Reset state
            resetTestState();
            
            // Run all program tests
            testCalculatorProgram();
            testGradeClassification();
            testMultiplicationTable();
            testNameProcessor();
            testShoppingCart();
            testStudentGradeAnalyzer();
            testNumberPatternGenerator();
            
            // Display results
            displayTestResults();
            
            // Validate counts for debugging
            validateTestCounts();
        }
        
        // Make functions available globally
        window.runAllTests = runAllTests;
        window.togglePassedTests = togglePassedTests;
        
        // Auto-run tests on page load
        document.addEventListener('DOMContentLoaded', function() {
            setupKeyboardShortcuts();
            runAllTests();
        });
    </script>
</body>
</html>
