<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trace Table Practice - End-to-End Integration Tests</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2d3748;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        
        .test-section h2 {
            color: #4a5568;
            margin-bottom: 15px;
        }
        
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        
        .test-pass {
            background: #c6f6d5;
            color: #2f855a;
            border: 1px solid #9ae6b4;
        }
        
        .test-fail {
            background: #fed7d7;
            color: #c53030;
            border: 1px solid #feb2b2;
        }
        
        .test-summary {
            font-size: 1.2em;
            font-weight: 600;
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
        }
        
        .run-tests-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .run-tests-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        
        .test-details {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            white-space: pre-wrap;
        }
        
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            margin: 10px 0;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 End-to-End Integration Tests</h1>
        <p style="color: #666; margin-bottom: 30px; font-size: 1.1em; line-height: 1.5;">
            <strong>Comprehensive program tests covering real-world GCSE scenarios</strong><br>
            <em>Focus: Complete programs with nested features, edge cases, and full trace validation</em><br>
            <small style="color: #888;">These tests complement unit tests by validating entire program flows and complex feature interactions.</small>
        </p>
        
        <button class="run-tests-btn" onclick="runAllTests()">🔄 Run All Integration Tests</button>
        
        <div id="testResults"></div>
        
        <div id="testSummary"></div>
    </div>

    <script type="module">
        /*
         * ======================================================================
         * END-TO-END INTEGRATION TESTS - SCOPE AND PURPOSE
         * ======================================================================
         * 
         * These integration tests focus on testing complete programs that students
         * would encounter in real GCSE Computer Science practice. They verify that
         * all components work together correctly in realistic scenarios.
         * 
         * INTEGRATION TEST SCOPE:
         * - Complete program execution with inputs and outputs
         * - Complex feature interactions (e.g., loops with string operations)
         * - Real-world GCSE programming scenarios
         * - Trace table generation for entire programs
         * - Input validation and error handling in context
         * - Multi-step calculations and workflows
         * - Programs with nested control structures
         * - Full validation of program state changes
         * 
         * WHAT INTEGRATION TESTS DON'T COVER:
         * - Individual method testing (covered by unit tests)
         * - Basic operator precedence (covered by unit tests)
         * - Simple edge cases (covered by unit tests)
         * - Isolated feature testing (covered by unit tests)
         * 
         * These tests complement unit tests by ensuring the interpreter
         * can handle complete programs correctly, not just individual features.
         * 
         * For individual feature testing, see tests.html
         * 
         * ======================================================================
         */
        
        // Import the actual production Interpreter class
        import { Interpreter } from './js/interpreter.js';
        
        // Test helper functions
        let testResults = [];
        let testsPassed = 0;
        let testsFailed = 0;
        
        function assert(condition, testName, details = '') {
            if (condition) {
                testResults.push({
                    name: testName,
                    passed: true,
                    details: details
                });
                testsPassed++;
            } else {
                testResults.push({
                    name: testName,
                    passed: false,
                    details: details
                });
                testsFailed++;
            }
        }
        
        function assertEqual(actual, expected, testName, details = '') {
            const condition = actual === expected;
            const testDetails = details + `\nExpected: ${expected}\nGot: ${actual}`;
            assert(condition, testName, testDetails);
        }
        
        function assertArrayEqual(actual, expected, testName, details = '') {
            const condition = JSON.stringify(actual) === JSON.stringify(expected);
            const testDetails = details + `\nExpected: ${JSON.stringify(expected)}\nGot: ${JSON.stringify(actual)}`;
            assert(condition, testName, testDetails);
        }
        
        // Use the actual interpreter for integration tests
        function executeTestProgram(code, inputs = []) {
            const interpreter = new Interpreter();
            
            // Create a program object similar to what the main app uses
            const program = {
                code: code,
                inputs: inputs,
                randomValue: undefined // For programs that don't use random
            };
            
            // Execute the program using the correct method
            const result = interpreter.executeProgram(code, program);
            
            return {
                variables: interpreter.variables || {},
                outputs: interpreter.outputs || [],
                trace: interpreter.trace || []
            };
        }
        
        // Test the rectangle calculation program
        // Test runner functions - Complete Program Integration Tests
        
        function testRectangleCalculationProgram() {
            // Test the complete rectangle calculation program with input validation
            const code = `length = int(input("Enter length"))
width = int(input("Enter width"))
area = length * width
perimeter = 2 * (length + width)
print("Area: " + str(area))
print("Perimeter: " + str(perimeter))`;
            
            const inputs = ["5", "3"];
            const result = executeTestProgram(code, inputs);
            
            assertEqual(result.variables.length, 5, 'Rectangle Program: Length Input');
            assertEqual(result.variables.width, 3, 'Rectangle Program: Width Input');
            assertEqual(result.variables.area, 15, 'Rectangle Program: Area Calculation');
            assertEqual(result.variables.perimeter, 16, 'Rectangle Program: Perimeter Calculation');
            assertArrayEqual(result.outputs, ["Area: 15", "Perimeter: 16"], 'Rectangle Program: Formatted Output');
            
            // Verify trace table structure
            assert(result.trace.length === 6, 'Rectangle Program: Complete Trace Table', `Expected 6 traced lines, got ${result.trace.length}`);
        }
        
        function testJumpQualificationProgram() {
            // Test the jump qualification program with nested conditionals
            const code = `jumpLength = float(input("Enter jump length"))
yearGroup = float(input("Enter year group"))
if jumpLength > 2 then
    if yearGroup >= 10 then
        print("You qualify for the team")
    else
        print("You are too young")
    endif
else
    print("Jump not long enough")
endif`;
            
            // Test case 1: Good jump, too young
            const inputs1 = ["2.2", "8"];
            const result1 = executeTestProgram(code, inputs1);
            assertEqual(result1.variables.jumpLength, 2.2, 'Jump Program Case 1: Jump Length');
            assertEqual(result1.variables.yearGroup, 8, 'Jump Program Case 1: Year Group');
            assertArrayEqual(result1.outputs, ["You are too young"], 'Jump Program Case 1: Correct Branch Output');
            
            // Test case 2: Good jump, qualified
            const inputs2 = ["2.5", "11"];
            const result2 = executeTestProgram(code, inputs2);
            assertArrayEqual(result2.outputs, ["You qualify for the team"], 'Jump Program Case 2: Qualification Output');
            
            // Test case 3: Poor jump
            const inputs3 = ["1.8", "12"];
            const result3 = executeTestProgram(code, inputs3);
            assertArrayEqual(result3.outputs, ["Jump not long enough"], 'Jump Program Case 3: Insufficient Jump Output');
        }
        
        function testDuckGroupingProgram() {
            // Test the duck grouping program (real GCSE example)
            const code = `ducks = int(input("How many ducks are there"))
groups = ducks DIV 4
leftOver = ducks MOD 4
print("Number of groups: " + str(groups))
print("Ducks left over: " + str(leftOver))`;
            
            const testCases = [
                { inputs: ["15"], groups: 3, leftOver: 3 },
                { inputs: ["22"], groups: 5, leftOver: 2 },
                { inputs: ["8"], groups: 2, leftOver: 0 }
            ];
            
            testCases.forEach((testCase, i) => {
                const result = executeTestProgram(code, testCase.inputs);
                assertEqual(result.variables.groups, testCase.groups, `Duck Program Case ${i+1}: Groups Calculation`);
                assertEqual(result.variables.leftOver, testCase.leftOver, `Duck Program Case ${i+1}: Remainder Calculation`);
                assertArrayEqual(result.outputs, [
                    `Number of groups: ${testCase.groups}`,
                    `Ducks left over: ${testCase.leftOver}`
                ], `Duck Program Case ${i+1}: Formatted Output`);
            });
        }
        
        function testLoopWithStringOperations() {
            // Test for loop with string methods (substring extraction)
            const code = `country = "France"
for x = 1 to 3
    letter = country.substring(x, 1)
    print("Position " + str(x) + ": " + letter)
next x`;
            
            const result = executeTestProgram(code);
            
            assertEqual(result.variables.country, "France", 'String Loop Program: Country Variable');
            assertEqual(result.variables.x, 3, 'String Loop Program: Final Loop Variable');
            assertArrayEqual(result.outputs, [
                "Position 1: r",
                "Position 2: a", 
                "Position 3: n"
            ], 'String Loop Program: Substring Extraction Output');
            
            // Verify proper trace pattern for loops
            assert(result.trace.length >= 7, 'String Loop Program: Trace Contains Loop Iterations');
        }
        
        function testConstantsWithCalculations() {
            // Test constants in a real calculation scenario
            const code = `const pi = 3.14159
const vatRate = 0.2
radius = float(input("Enter radius"))
price = float(input("Enter price"))
area = pi * radius * radius
priceWithVat = price * (1 + vatRate)
print("Circle area: " + str(area))
print("Price with VAT: " + str(priceWithVat))`;
            
            const inputs = ["5", "100"];
            const result = executeTestProgram(code, inputs);
            
            assertEqual(result.variables.pi, 3.14159, 'Constants Program: Pi Constant');
            assertEqual(result.variables.vatRate, 0.2, 'Constants Program: VAT Rate Constant');
            assertEqual(result.variables.radius, 5, 'Constants Program: Radius Input');
            assertEqual(result.variables.price, 100, 'Constants Program: Price Input');
            assert(Math.abs(result.variables.area - 78.53975) < 0.001, 'Constants Program: Circle Area Calculation');
            assertEqual(result.variables.priceWithVat, 120, 'Constants Program: VAT Calculation');
            assert(result.outputs.length === 2, 'Constants Program: Two Output Lines');
        }
        
        function testSwitchCaseGradingSystem() {
            // Test switch/case with a grading system
            const code = `score = int(input("Enter score"))
switch score:
case 90:
case 91:
case 92:
case 93:
case 94:
case 95:
case 96:
case 97:
case 98:
case 99:
case 100:
    grade = "A*"
case 80:
case 81:
case 82:
case 83:
case 84:
case 85:
case 86:
case 87:
case 88:
case 89:
    grade = "A"
default:
    grade = "Below A"
endswitch
print("Your grade is: " + grade)`;
            
            // Test different score ranges
            const testCases = [
                { inputs: ["95"], expected: "A*" },
                { inputs: ["85"], expected: "A" }, 
                { inputs: ["75"], expected: "Below A" }
            ];
            
            testCases.forEach((testCase, i) => {
                const result = executeTestProgram(code, testCase.inputs);
                assertEqual(result.variables.grade, testCase.expected, `Grading Program Case ${i+1}: Grade Assignment`);
                assertArrayEqual(result.outputs, [`Your grade is: ${testCase.expected}`], `Grading Program Case ${i+1}: Grade Output`);
            });
        }
        
        function testForLoopWithSteps() {
            // Test for loop with custom steps (countdown timer)
            const code = `for countdown = 10 to 0 step -2
    print("T-minus " + str(countdown))
next countdown
print("Launch!")`;
            
            const result = executeTestProgram(code);
            
            assertEqual(result.variables.countdown, 0, 'Step Loop Program: Final Countdown Variable');
            assertArrayEqual(result.outputs, [
                "T-minus 10",
                "T-minus 8", 
                "T-minus 6",
                "T-minus 4",
                "T-minus 2",
                "T-minus 0",
                "Launch!"
            ], 'Step Loop Program: Countdown Sequence');
        }
        
        function testComplexValidationProgram() {
            // Test a complex program with multiple validation steps
            const code = `// Password validation program
password = input("Enter password")
length = password.length
hasUpper = false
hasNumber = false

for i = 0 to length - 1
    char = password.substring(i, 1)
    if char >= "A" AND char <= "Z" then
        hasUpper = true
    endif
    if char >= "0" AND char <= "9" then
        hasNumber = true
    endif
next i

if length >= 8 AND hasUpper AND hasNumber then
    print("Password is strong")
else
    print("Password is weak")
endif`;
            
            // Test strong password
            const inputs1 = ["MyPass123"];
            const result1 = executeTestProgram(code, inputs1);
            assertEqual(result1.variables.hasUpper, true, 'Validation Program: Upper Case Detection');
            assertEqual(result1.variables.hasNumber, true, 'Validation Program: Number Detection');
            assertArrayEqual(result1.outputs, ["Password is strong"], 'Validation Program: Strong Password Output');
            
            // Test weak password
            const inputs2 = ["weak"];
            const result2 = executeTestProgram(code, inputs2);
            assertArrayEqual(result2.outputs, ["Password is weak"], 'Validation Program: Weak Password Output');
        }

        function runAllTests() {
            // Reset test results
            testResults = [];
            testsPassed = 0;
            testsFailed = 0;
            
            // Run comprehensive end-to-end program tests
            // These tests focus on complete programs and features not covered by unit tests
            testRectangleCalculationProgram();
            testJumpQualificationProgram();
            testDuckGroupingProgram();
            testLoopWithStringOperations();
            testConstantsWithCalculations();
            testSwitchCaseGradingSystem();
            testForLoopWithSteps();
            testComplexValidationProgram();
            
            // Display results
            displayTestResults();
        }
        
        function displayTestResults() {
            const resultsDiv = document.getElementById('testResults');
            const summaryDiv = document.getElementById('testSummary');
            
            // Group tests by category - Comprehensive End-to-End Tests
            const testSuites = {
                'Rectangle Calculation Program': [
                    'Rectangle Program: Length Input',
                    'Rectangle Program: Width Input', 
                    'Rectangle Program: Area Calculation',
                    'Rectangle Program: Perimeter Calculation',
                    'Rectangle Program: Formatted Output',
                    'Rectangle Program: Complete Trace Table'
                ],
                'Jump Qualification Program (Nested Conditionals)': [
                    'Jump Program Case 1: Jump Length',
                    'Jump Program Case 1: Year Group',
                    'Jump Program Case 1: Correct Branch Output',
                    'Jump Program Case 2: Qualification Output',
                    'Jump Program Case 3: Insufficient Jump Output'
                ],
                'Duck Grouping Program (DIV/MOD Operations)': [
                    'Duck Program Case 1: Groups Calculation',
                    'Duck Program Case 1: Remainder Calculation',
                    'Duck Program Case 1: Formatted Output',
                    'Duck Program Case 2: Groups Calculation',
                    'Duck Program Case 2: Remainder Calculation',
                    'Duck Program Case 2: Formatted Output',
                    'Duck Program Case 3: Groups Calculation',
                    'Duck Program Case 3: Remainder Calculation',
                    'Duck Program Case 3: Formatted Output'
                ],
                'String Operations in Loops': [
                    'String Loop Program: Country Variable',
                    'String Loop Program: Final Loop Variable',
                    'String Loop Program: Substring Extraction Output',
                    'String Loop Program: Trace Contains Loop Iterations'
                ],
                'Constants with Real Calculations': [
                    'Constants Program: Pi Constant',
                    'Constants Program: VAT Rate Constant',
                    'Constants Program: Radius Input',
                    'Constants Program: Price Input',
                    'Constants Program: Circle Area Calculation',
                    'Constants Program: VAT Calculation',
                    'Constants Program: Two Output Lines'
                ],
                'Switch/Case Grading System': [
                    'Grading System Case 1: Grade Variable A',
                    'Grading System Case 1: Output Excellent',
                    'Grading System Case 2: Grade Variable B',
                    'Grading System Case 2: Output Good',
                    'Grading System Case 3: Grade Variable F',
                    'Grading System Case 3: Output Fail'
                ],
                'For Loop with Steps (Countdown)': [
                    'Step Loop Program: Final Countdown Variable',
                    'Step Loop Program: Countdown Sequence'
                ],
                'Complex Validation Program': [
                    'Validation Program: Upper Case Detection',
                    'Validation Program: Number Detection',
                    'Validation Program: Strong Password Output',
                    'Validation Program: Weak Password Output'
                ]
            };
            
            let html = '';
            
            for (const [suiteName, testNames] of Object.entries(testSuites)) {
                html += `<div class="test-section">`;
                html += `<h2>${suiteName}</h2>`;
                
                for (const testName of testNames) {
                    const result = testResults.find(r => r.name === testName);
                    if (result) {
                        const cssClass = result.passed ? 'test-pass' : 'test-fail';
                        const status = result.passed ? '✅ PASS' : '❌ FAIL';
                        html += `<div class="test-result ${cssClass}">`;
                        html += `<strong>${status}</strong> - ${result.name}`;
                        if (result.details) {
                            html += `<div class="test-details">${result.details}</div>`;
                        }
                        html += `</div>`;
                    }
                }
                
                html += `</div>`;
            }
            
            resultsDiv.innerHTML = html;
            
            // Display summary
            const totalTests = testsPassed + testsFailed;
            const passRate = ((testsPassed / totalTests) * 100).toFixed(1);
            const summaryClass = testsFailed === 0 ? 'test-pass' : 'test-fail';
            
            summaryDiv.innerHTML = `
                <div class="test-summary ${summaryClass}">
                    <strong>Integration Test Summary:</strong> ${testsPassed}/${totalTests} tests passed (${passRate}%)
                    ${testsFailed > 0 ? `<br><strong>${testsFailed} tests failed</strong>` : '<br><strong>All integration tests passed! 🎉</strong>'}
                </div>
            `;
        }
        
        // Make runAllTests available globally for the button
        window.runAllTests = runAllTests;
        
        // Auto-run tests on page load
        document.addEventListener('DOMContentLoaded', function() {
            runAllTests();
        });
    </script>
</body>
</html>
