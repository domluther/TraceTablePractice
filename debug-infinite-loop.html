<!DOCTYPE html>
<html>
<head>
    <title>Substring Infinite Loop Debug</title>
</head>
<body>
    <h2>Debug: Finding the Infinite Loop</h2>
    <div id="results"></div>

    <script type="module">
        import { Interpreter } from './js/interpreter.js';

        const interpreter = new Interpreter();
        const results = document.getElementById('results');

        function log(message) {
            console.log(message);
            const div = document.createElement('div');
            div.textContent = message;
            div.style.margin = '5px 0';
            div.style.fontFamily = 'monospace';
            results.appendChild(div);
        }

        // Let's test the exact issue more specifically
        log("=== Testing the exact problem ===");
        
        try {
            // Test if isArithmeticExpression is the issue
            const testStr = "country.substring(x, 2)";
            log(`Testing: ${testStr}`);
            log(`isArithmeticExpression returns: ${interpreter.isArithmeticExpression(testStr)}`);
            
            // Test if evaluateArithmeticExpression causes the infinite loop
            if (interpreter.isArithmeticExpression(testStr)) {
                log("⚠️ This will go to arithmetic expression handler!");
                log("Testing evaluateArithmeticExpression...");
                
                // Add timeout to prevent browser freeze
                const timeout = setTimeout(() => {
                    throw new Error("evaluateArithmeticExpression is causing infinite loop!");
                }, 1000);
                
                try {
                    const result = interpreter.evaluateArithmeticExpression(testStr, {x: 1, country: "France"});
                    clearTimeout(timeout);
                    log(`✅ evaluateArithmeticExpression result: ${result}`);
                } catch (e) {
                    clearTimeout(timeout);
                    log(`❌ evaluateArithmeticExpression error: ${e.message}`);
                }
            }
            
        } catch (e) {
            log(`❌ Error in test: ${e.message}`);
        }

        // Test the specific method that might be causing issues
        log("\n=== Testing Method Detection ===");
        const testContent = "country.substring(x, 2)";
        const testVars = { x: 1, country: "France" };
        
        log(`Content: ${testContent}`);
        log(`isStringConcatenation: ${interpreter.isStringConcatenation(testContent, testVars)}`);
        log(`isArithmeticExpression: ${interpreter.isArithmeticExpression(testContent)}`);
        log(`includes .substring(: ${testContent.includes('.substring(')}`);
        
        // Test the regex match
        const match = testContent.match(/(\w+)\.substring\(([^,]+),\s*([^)]+)\)/);
        if (match) {
            log(`Regex match found:`);
            log(`  Variable: ${match[1]}`);
            log(`  Start param: ${match[2]}`);
            log(`  Length param: ${match[3]}`);
        } else {
            log(`❌ Regex match failed!`);
        }
    </script>
</body>
</html>
