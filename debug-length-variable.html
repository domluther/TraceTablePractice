<!DOCTYPE html>
<html>
<head>
    <title>Length Variable Debug</title>
</head>
<body>
    <h2>Debug: Length Variable Assignment</h2>
    <div id="results"></div>

    <script type="module">
        import { Interpreter } from './js/interpreter.js';

        const interpreter = new Interpreter();
        const results = document.getElementById('results');

        function log(message) {
            console.log(message);
            const div = document.createElement('div');
            div.textContent = message;
            div.style.margin = '5px 0';
            div.style.fontFamily = 'monospace';
            results.appendChild(div);
        }

        // Test the exact problematic scenario
        log("=== Testing Length Variable Assignment ===");
        
        try {
            const result = interpreter.execute(`name = "Alice"
length = name.length
print(length)`);
            
            log(`Variables: ${JSON.stringify(result.variables)}`);
            log(`Outputs: [${result.outputs.join(', ')}]`);
            log(`Trace entries: ${result.trace.length}`);
            
            result.trace.forEach((entry, index) => {
                log(`Trace ${index + 1}: Line ${entry.lineNumber}, vars=${JSON.stringify(entry.variables)}, output="${entry.output}"`);
            });
            
        } catch (e) {
            log(`❌ Error: ${e.message}`);
        }

        // Test the full loop scenario
        log("\n=== Testing Full Loop Scenario ===");
        
        try {
            const testProgram = { 
                inputs: ["Alice", "Bob", "Charlie"],
                randomValue: undefined 
            };
            
            const result2 = interpreter.executeProgram(`for x = 1 to 3
    name = input("Enter a name")
    length = name.length
    print(x * length)
next x`, testProgram);
            
            log(`Final variables: ${JSON.stringify(result2.variables)}`);
            log(`Outputs: [${result2.outputs.join(', ')}]`);
            
            // Check if length variable appears in trace
            const lengthTraces = result2.trace.filter(entry => 
                entry.variables.hasOwnProperty('length') || 
                entry.changedVariables.hasOwnProperty('length')
            );
            log(`Traces with 'length' variable: ${lengthTraces.length}`);
            
            lengthTraces.forEach((entry, index) => {
                log(`Length trace ${index + 1}: Line ${entry.lineNumber}, length=${entry.variables.length}, changed=${JSON.stringify(entry.changedVariables)}`);
            });
            
        } catch (e) {
            log(`❌ Error in loop: ${e.message}`);
        }
    </script>
</body>
</html>
