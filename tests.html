<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü¶Ü Mr Luther's OCR J277 Trace Table Practice - Unit Tests ü¶Ü</title>
    <link rel="stylesheet" href="css/test-styles.css">
</head>
<body>
    <div class="container">
        <h1>üß™ Mr Luther's OCR J277 Trace Table Practice - Unit Tests ü¶Ü</h1>
        
        <div id="testSummary"></div>
        
        <button class="run-tests-btn" onclick="runAllTests()">üîÑ Run All Tests</button>
        <button class="toggle-btn" id="togglePassedBtn" onclick="togglePassedTests()" title="Toggle passed tests visibility (Shortcut: H key)">üëÅÔ∏è Show Passed Tests</button>
        
        <div id="testResults"></div>
    </div>

    <script type="module">
        // ============================================================================
        // UNIT TESTS - SCOPE AND PURPOSE
        // ============================================================================
        /*
         * These unit tests focus on testing individual interpreter methods and
         * language features in isolation. They verify that each component works
         * correctly on its own, without testing complete program flows.
         * 
         * UNIT TEST SCOPE:
         * - Individual arithmetic operations and operator precedence
         * - String methods (.upper, .lower, .left, .substring, etc.)
         * - Array access and indexing
         * - Type conversions (float, int, bool)
         * - Basic control structures (for loops, switch/case)
         * - Language features (comments, constants)
         * - Edge cases and error conditions
         * - Expression evaluation and parsing
         * 
         * DESIGN PRINCIPLES:
         * - Each test function focuses on one specific feature or capability
         * - Tests are independent and can run in any order
         * - Clear naming conventions make test purpose obvious
         * - Comprehensive coverage without redundancy
         * - Maintainable structure with clear section organization
         * 
         * For comprehensive program testing, see integration-tests.html
         */
        
        // ============================================================================
        // TEST FRAMEWORK AND UTILITIES
        // ============================================================================
        
        // Import the actual production Interpreter class
        import { ASTInterpreter as Interpreter} from "./js/ast.js";
        
        // Test state management
        let testResults = [];
        let testsPassed = 0;
        let testsFailed = 0;
        
        /**
         * Core assertion function for unit testing
         * @param {boolean} condition - The condition to test
         * @param {string} testName - Descriptive name of the test
         * @param {string} details - Additional diagnostic information
         */
        function assert(condition, testName, details = '') {
            if (condition) {
                testResults.push({
                    name: testName,
                    passed: true,
                    details: details
                });
                testsPassed++;
            } else {
                testResults.push({
                    name: testName,
                    passed: false,
                    details: details
                });
                testsFailed++;
            }
        }
        
        /**
         * Equality assertion with detailed failure reporting
         * @param {any} actual - The actual value produced
         * @param {any} expected - The expected value
         * @param {string} testName - Descriptive name of the test
         * @param {string} details - Additional context
         */
        function assertEqual(actual, expected, testName, details = '') {
            const condition = actual === expected;
            const testDetails = details + ` (Expected: ${expected}, Got: ${actual})`;
            assert(condition, testName, testDetails);
        }
        
        /**
         * Array equality assertion for comprehensive comparisons
         * @param {Array} actual - The actual array produced
         * @param {Array} expected - The expected array
         * @param {string} testName - Descriptive name of the test
         * @param {string} details - Additional context
         */
        function assertArrayEqual(actual, expected, testName, details = '') {
            const condition = JSON.stringify(actual) === JSON.stringify(expected);
            const testDetails = details + ` (Expected: ${JSON.stringify(expected)}, Got: ${JSON.stringify(actual)})`;
            assert(condition, testName, testDetails);
        }

        /**
         * Helper function to execute code and get variable value
         * @param {string} code - The code to execute
         * @param {string} varName - The variable name to check
         * @param {Object} inputData - Optional input data for the interpreter
         * @returns {any} The value of the specified variable
         */
        function executeAndGetVariable(code, varName, inputData = {}) {
            const interpreter = new Interpreter();
            const result = interpreter.executeProgram(code, inputData);
            return interpreter.variables[varName];
        }

        /**
         * Helper function to execute code and get all variables
         * @param {string} code - The code to execute
         * @param {Object} inputData - Optional input data for the interpreter
         * @returns {Object} All variables from the interpreter
         */
        function executeAndGetVariables(code, inputData = {}) {
            const interpreter = new Interpreter();
            const result = interpreter.executeProgram(code, inputData);
            return interpreter.variables;
        }

        /**
         * Helper function to execute code and get outputs
         * @param {string} code - The code to execute
         * @param {Object} inputData - Optional input data for the interpreter
         * @returns {Array} Array of output strings
         */
        function executeAndGetOutputs(code, inputData = {}) {
            const interpreter = new Interpreter();
            const result = interpreter.executeProgram(code, inputData);
            return result.outputs;
        }
        
        // ============================================================================
        // BASIC ARITHMETIC OPERATIONS TESTS
        // ============================================================================
        
        /**
         * Test basic arithmetic operations
         * Covers: addition, subtraction, multiplication, division, modulo, exponentiation
         */
        function testBasicArithmetic() {
            // Test basic operations by assigning results to variables
            assertEqual(executeAndGetVariable(`
                a = 5
                b = 3
                result = a + b
            `, 'result'), 8, 'Basic Addition (5 + 3 = 8)');
            
            assertEqual(executeAndGetVariable(`
                a = 5
                b = 3
                result = a - b
            `, 'result'), 2, 'Basic Subtraction (5 - 3 = 2)');
            
            assertEqual(executeAndGetVariable(`
                a = 5
                b = 3
                result = a * b
            `, 'result'), 15, 'Basic Multiplication (5 * 3 = 15)');
            
            assertEqual(executeAndGetVariable(`
                a = 5
                c = 2
                result = a / c
            `, 'result'), 2.5, 'Basic Division (5 / 2 = 2.5)');
            
            assertEqual(executeAndGetVariable(`
                a = 5
                b = 3
                result = a MOD b
            `, 'result'), 2, 'Basic Modulo (5 MOD 3 = 2)');
            
            assertEqual(executeAndGetVariable(`
                a = 5
                b = 3
                result = a DIV b
            `, 'result'), 1, 'Basic Integer Division (5 DIV 3 = 1)');
            
            assertEqual(executeAndGetVariable(`
                b = 3
                c = 2
                result = b ^ c
            `, 'result'), 9, 'Basic Exponentiation (3 ^ 2 = 9)');
        }
        
        /**
         * Test operator precedence rules
         * Covers: order of operations, left-to-right evaluation
         */
        function testOperatorPrecedence() {
            // Test precedence rules
            assertEqual(executeAndGetVariable(`
                a = 2
                b = 3
                c = 4
                result = a + b * c
            `, 'result'), 14, 'Multiplication before Addition (2 + 3 * 4 = 14)');
            
            assertEqual(executeAndGetVariable(`
                a = 2
                b = 3
                c = 4
                result = c / a - b
            `, 'result'), -1, 'Division before Subtraction (4 / 2 - 3 = -1)');
            
            assertEqual(executeAndGetVariable(`
                a = 2
                b = 3
                result = a * b ^ a
            `, 'result'), 18, 'Exponentiation before Multiplication (2 * 3 ^ 2 = 18)');
            
            assertEqual(executeAndGetVariable(`
                a = 2
                b = 3
                c = 4
                result = a + b - c
            `, 'result'), 1, 'Left-to-right for Addition/Subtraction (2 + 3 - 4 = 1)');
            
            assertEqual(executeAndGetVariable(`
                a = 2
                b = 3
                result = a * b / a
            `, 'result'), 3, 'Left-to-right for Multiplication/Division (2 * 3 / 2 = 3)');
        }
        
        /**
         * Test parentheses in expressions
         * Covers: grouping, nested parentheses, complex expressions
         */
        function testParentheses() {
            // Test parentheses
            assertEqual(executeAndGetVariable(`
                a = 2
                b = 3
                c = 4
                result = (a + b) * c
            `, 'result'), 20, 'Basic Parentheses ((2 + 3) * 4 = 20)');
            
            assertEqual(executeAndGetVariable(`
                a = 2
                b = 3
                c = 4
                result = ((a + b) * c) / (a + c)
            `, 'result'), 20/6, 'Nested Parentheses (((2 + 3) * 4) / (2 + 4) = 20/6)');
            
            // Rectangle perimeter calculation
            assertEqual(executeAndGetVariable(`
                length = 5
                width = 3
                result = 2 * (length + width)
            `, 'result'), 16, 'Rectangle Perimeter (2 * (5 + 3) = 16)');
            
            assertEqual(executeAndGetVariable(`
                a = 2
                b = 3
                c = 4
                result = (a + b) * (c - a)
            `, 'result'), 10, 'Complex Parentheses ((2 + 3) * (4 - 2) = 10)');
        }
        
        /**
         * Test array access operations
         * Covers: variable indices, literal indices, arithmetic with arrays
         */
        function testArrayAccess() {
            // Test array access
            assertEqual(executeAndGetVariable(`
                array nums = [10, 20, 30]
                i = 1
                result = nums[i]
            `, 'result'), 20, 'Array Access with Variable Index (nums[1] = 20)');
            
            assertEqual(executeAndGetVariable(`
                array nums = [10, 20, 30]
                result = nums[0]
            `, 'result'), 10, 'Array Access with Literal Index (nums[0] = 10)');
            
            assertEqual(executeAndGetVariable(`
                array nums = [10, 20, 30]
                i = 1
                j = 0
                result = nums[i] + nums[j]
            `, 'result'), 30, 'Arithmetic with Array Access (nums[1] + nums[0] = 30)');
            
            assertEqual(executeAndGetVariable(`
                array nums = [10, 20, 30]
                i = 1
                result = nums[i] * 2
            `, 'result'), 40, 'Array Access in Multiplication (nums[1] * 2 = 40)');
        }
        
        /**
         * Test string method operations
         * Covers: .upper, .lower, .left, string concatenation
         */
        function testStringMethods() {
            // Test string methods
            assertEqual(executeAndGetVariable(`
                first_name = "John"
                result = first_name.left(1)
            `, 'result'), 'J', 'First name .left(1) should return "J"');
            
            assertEqual(executeAndGetVariable(`
                last_name = "Smith"
                result = last_name.left(1)
            `, 'result'), 'S', 'Last name .left(1) should return "S"');
            
            assertEqual(executeAndGetVariable(`
                first_name = "John"
                last_name = "Smith"
                result = first_name.left(1) + last_name.left(1)
            `, 'result'), 'JS', 'Initials concatenation should return "JS"');
            
            assertEqual(executeAndGetVariable(`
                first_name = "John"
                result = first_name.upper()
            `, 'result'), 'JOHN', 'String .upper method');
            
            assertEqual(executeAndGetVariable(`
                first_name = "John"
                result = first_name.lower()
            `, 'result'), 'john', 'String .lower method');
        }
        
        /**
         * Test ASCII conversion functions ASC() and CHR()
         * Covers: character to ASCII value conversion, ASCII to character conversion
         */
        function testASCAndCHRFunctions() {
            // Basic ASC() tests
            assertEqual(executeAndGetVariable(`
                result = asc("A")
            `, 'result'), 65, 'ASC("A") should return 65');
            
            assertEqual(executeAndGetVariable(`
                result = asc("Z")
            `, 'result'), 90, 'ASC("Z") should return 90');
            
            assertEqual(executeAndGetVariable(`
                result = asc("a")
            `, 'result'), 97, 'ASC("a") should return 97');
            
            assertEqual(executeAndGetVariable(`
                result = asc("0")
            `, 'result'), 48, 'ASC("0") should return 48');
            
            assertEqual(executeAndGetVariable(`
                result = asc(" ")
            `, 'result'), 32, 'ASC(" ") should return 32');
            
            // ASC() with variables
            assertEqual(executeAndGetVariable(`
                letter = "A"
                result = asc(letter)
            `, 'result'), 65, 'ASC(letter) with A should return 65');
            
            // Basic CHR() tests
            assertEqual(executeAndGetVariable(`
                result = chr(65)
            `, 'result'), 'A', 'CHR(65) should return "A"');
            
            assertEqual(executeAndGetVariable(`
                result = chr(90)
            `, 'result'), 'Z', 'CHR(90) should return "Z"');
            
            assertEqual(executeAndGetVariable(`
                result = chr(97)
            `, 'result'), 'a', 'CHR(97) should return "a"');
            
            assertEqual(executeAndGetVariable(`
                result = chr(48)
            `, 'result'), '0', 'CHR(48) should return "0"');
            
            assertEqual(executeAndGetVariable(`
                result = chr(32)
            `, 'result'), ' ', 'CHR(32) should return space');
            
            // CHR() with variables
            assertEqual(executeAndGetVariable(`
                ascii_val = 65
                result = chr(ascii_val)
            `, 'result'), 'A', 'CHR(ascii_val) with 65 should return "A"');
        }
        
        /**
         * Test boolean operators AND/OR in conditions
         * Covers: AND operator, OR operator (uppercase)
         */
        function testBooleanOperators() {
            // Test AND operator
            assertEqual(executeAndGetVariable(`
                x = 5
                y = 10
                if x < 10 AND y > 5 then
                    result = true
                else
                    result = false
                endif
            `, 'result'), true, 'AND: Both conditions true should return true');
            
            assertEqual(executeAndGetVariable(`
                x = 5
                y = 10
                if x < 3 AND y > 5 then
                    result = true
                else
                    result = false
                endif
            `, 'result'), false, 'AND: First false should return false');
            
            assertEqual(executeAndGetVariable(`
                x = 5
                y = 10
                if x < 10 AND y > 15 then
                    result = true
                else
                    result = false
                endif
            `, 'result'), false, 'AND: Second false should return false');
            
            // Test OR operator
            assertEqual(executeAndGetVariable(`
                x = 5
                y = 10
                if x < 10 OR y > 15 then
                    result = true
                else
                    result = false
                endif
            `, 'result'), true, 'OR: First true should return true');
            
            assertEqual(executeAndGetVariable(`
                x = 5
                y = 10
                if x > 10 OR y > 5 then
                    result = true
                else
                    result = false
                endif
            `, 'result'), true, 'OR: Second true should return true');
            
            assertEqual(executeAndGetVariable(`
                x = 5
                y = 10
                if x > 10 OR y < 5 then
                    result = true
                else
                    result = false
                endif
            `, 'result'), false, 'OR: Both false should return false');
            
            // Test with ASCII functions
            assertEqual(executeAndGetVariable(`
                char = "A"
                if asc(char) >= 65 AND asc(char) <= 90 then
                    result = true
                else
                    result = false
                endif
            `, 'result'), true, 'ASCII range check with AND should work');
        }
        
        /**
         * Test for loop execution
         * Covers: loop variables, trace entries, output generation
         */
        function testForLoopExecution() {
            const outputs = executeAndGetOutputs(`
                for x = 0 to 2
                    print(x*2)
                next x
            `);
            
            assertEqual(executeAndGetVariable(`
                for x = 0 to 2
                    y = x * 2
                next x
            `, 'x'), 2, 'x should be 2 after loop completion');
            
            assertEqual(outputs.length, 3, 'Should have exactly 3 outputs');
            assertEqual(outputs[0], '0', 'First output should be "0"');
            assertEqual(outputs[1], '2', 'Second output should be "2"');
            assertEqual(outputs[2], '4', 'Third output should be "4"');
        }
        
        /**
         * Test variable operations and expressions
         * Covers: variable access, numeric literals, expression evaluation
         */
        function testVariableOperations() {
            // Test variable access
            assertEqual(executeAndGetVariable(`
                x = 10
                result = x
            `, 'result'), 10, 'Variable Access (x = 10)');
            
            assertEqual(executeAndGetVariable(`
                temp = 5
                result = temp
            `, 'result'), 5, 'Variable Access (temp = 5)');
            
            // Test numeric literals
            assertEqual(executeAndGetVariable(`
                result = 42
            `, 'result'), 42, 'Numeric Literal (42)');
            
            assertEqual(executeAndGetVariable(`
                result = 0
            `, 'result'), 0, 'Numeric Literal (0)');
        }
        
        /**
         * Test complex expressions
         * Covers: multi-operator expressions, nested operations
         */
        function testComplexExpressions() {
            // Test complex arithmetic expression
            assertEqual(executeAndGetVariable(`
                a = 2
                b = 3
                c = 4
                array nums = [1, 2, 3, 4, 5]
                index = 2
                result = a * b + c * (a + b) - nums[index]
            `, 'result'), 23, 'Complex Expression (2 * 3 + 4 * (2 + 3) - 3 = 23)');
            
            // Test expression with multiple operators
            assertEqual(executeAndGetVariable(`
                a = 2
                b = 3
                c = 4
                array nums = [1, 2, 3, 4, 5]
                result = a ^ b + c / a * nums[0]
            `, 'result'), 10, 'Multiple Operators (2 ^ 3 + 4 / 2 * 1 = 10)');
        }
        
        /**
         * Test edge cases and boundary conditions
         * Covers: division by one, multiplication by zero, array bounds
         */
        function testEdgeCases() {
            // Test edge operations
            assertEqual(executeAndGetVariable(`
                zero = 0
                one = 1
                ten = 10
                result = ten / one
            `, 'result'), 10, 'Division by One (10 / 1 = 10)');
            
            assertEqual(executeAndGetVariable(`
                zero = 0
                ten = 10
                result = ten * zero
            `, 'result'), 0, 'Multiplication by Zero (10 * 0 = 0)');
            
            assertEqual(executeAndGetVariable(`
                zero = 0
                ten = 10
                result = ten ^ zero
            `, 'result'), 1, 'Power of Zero (10 ^ 0 = 1)');
            
            // Test array bounds (should return 0 for out of bounds)
            assertEqual(executeAndGetVariable(`
                array emptyArray = []
                result = emptyArray[0]
            `, 'result'), 0, 'Empty Array Access (should return 0)');
            
            assertEqual(executeAndGetVariable(`
                array smallArray = [42]
                result = smallArray[5]
            `, 'result'), 0, 'Out of Bounds Array Access (should return 0)');
        }
        
        /**
         * Test type conversions
         * Covers: float(), int(), str(), bool() type casting with various input types
         */
        function testTypeConversions() {
            // Test float conversion
            assertEqual(executeAndGetVariable(`
                result = float("3.14")
            `, 'result'), 3.14, 'float("3.14") should convert to 3.14');
            
            assertEqual(executeAndGetVariable(`
                numValue = 7
                result = float(numValue)
            `, 'result'), 7.0, 'float(numValue) should convert variable to 7.0');
            
            // Test int conversion
            assertEqual(executeAndGetVariable(`
                numValue = 42
                result = int(numValue)
            `, 'result'), 42, 'int(numValue) should convert variable to 42');
            
            assertEqual(executeAndGetVariable(`
                floatValue = 3.14
                result = int(floatValue)
            `, 'result'), 3, 'int(3.14) should convert variable to 3');
            
            assertEqual(executeAndGetVariable(`
                result = int(0)
            `, 'result'), 0, 'int(0) should convert variable to 0');
            
            // Test str conversion
            assertEqual(executeAndGetVariable(`
                result = str(42)
            `, 'result'), "42", 'str(42) should convert to "42"');
            
            // Test bool conversion
            assertEqual(executeAndGetVariable(`
                result = bool("true")
            `, 'result'), true, 'bool("true") should be true');
            
            assertEqual(executeAndGetVariable(`
                result = bool("false")
            `, 'result'), false, 'bool("false") should be false');
            
            assertEqual(executeAndGetVariable(`
                zeroNum = 0
                result = bool(zeroNum)
            `, 'result'), false, 'bool(0) should be false');
            
            assertEqual(executeAndGetVariable(`
                oneNum = 1
                result = bool(oneNum)
            `, 'result'), true, 'bool(1) should be true');
        }
        
        /**
         * Test nested conditional execution
         */
        function testNestedConditionalExecution() {
            // Test basic nested if with both conditions true
            const vars1 = executeAndGetVariables(`
                jumpLength = 3.5
                yearGroup = 12
                if jumpLength > 2 then
                    if yearGroup >= 10 then
                        result = "qualify"
                    else
                        result = "too young"
                    endif
                else
                    result = "not long enough"
                endif
            `);
            
            assertEqual(vars1.jumpLength, 3.5, 'Nested If - Both True: jumpLength should be 3.5');
            assertEqual(vars1.yearGroup, 12, 'Nested If - Both True: yearGroup should be 12');
            assertEqual(vars1.result, "qualify", 'Nested If - Both True: Should execute inner if branch when both conditions true');
            
            // Test MOD operator in conditions within for loop
            const outputs = executeAndGetOutputs(`
                total = 0
                for i = 1 to 5
                    if i MOD 2 == 0 then
                        total = total + i
                        print("even: " + str(i))
                    else
                        print("odd: " + str(i))
                    endif
                next i
            `);
            
            assertEqual(executeAndGetVariable(`
                total = 0
                for i = 1 to 5
                    if i MOD 2 == 0 then
                        total = total + i
                    endif
                next i
            `, 'total'), 6, 'MOD in For Loop: total should be 6 (2 + 4)');
        }
        
        /**
         * Test string methods in print statements
         */
        function testStringMethodsInPrint() {
            const outputs = executeAndGetOutputs(`
                name = "hello"
                city = "WORLD"
                print(name.upper())
                print(city.lower())
                print(str(name.length))
            `);
            
            assertEqual(outputs.length, 3, 'String Methods in Print: Should have exactly 3 outputs');
            assertEqual(outputs[0], 'HELLO', 'String Methods in Print: .upper conversion should output "HELLO"');
            assertEqual(outputs[1], 'world', 'String Methods in Print: .lower conversion should output "world"');
            assertEqual(outputs[2], '5', 'String Methods in Print: .length property should output "5"');
        }
        
        /**
         * Test substring method with dynamic loop variables
         */
        function testSubstringWithVariable() {
            const outputs = executeAndGetOutputs(`
                for x = 1 to 3
                    country = "France"
                    print(country.substring(x, 1))
                next x
            `);
            
            assertEqual(outputs.length, 3, 'Substring with Variable: Should have exactly 3 outputs');
            assertEqual(outputs[0], 'r', 'Substring with Variable: Position 1 extraction should be "r"');
            assertEqual(outputs[1], 'a', 'Substring with Variable: Position 2 extraction should be "a"');
            assertEqual(outputs[2], 'n', 'Substring with Variable: Position 3 extraction should be "n"');
        }
        
        /**
         * Test comment handling
         */
        function testComments() {
            const vars = executeAndGetVariables(`
                // This is a comment
                x = 5
                // Another comment here
                y = 10
                // Final comment
                z = x + y
            `);
            
            assertEqual(vars.x, 5, 'x should be 5 despite comments');
            assertEqual(vars.y, 10, 'y should be 10 despite comments');
            assertEqual(vars.z, 15, 'z should be 15 (x + y)');
        }
        
        /**
         * Test constant declarations
         */
        function testConstants() {
            const vars = executeAndGetVariables(`
                const pi = 3.14159
                const vat = 0.2
                price = 100
                total = price * (1 + vat)
            `);
            
            assertEqual(vars.pi, 3.14159, 'const pi should be 3.14159');
            assertEqual(vars.vat, 0.2, 'const vat should be 0.2');
            assertEqual(vars.total, 120, 'total should be 120 (100 * 1.2)');
        }
        
        /**
         * Test for loops with positive step values
         */
        function testForLoopWithPositiveStep() {
            const outputs = executeAndGetOutputs(`
                for i = 2 to 10 step 2
                    print(str(i))
                next i
            `);
            
            assertEqual(outputs.length, 5, 'Positive Step For Loop: Should have 5 outputs for step 2');
            assertEqual(outputs[0], '2', 'Positive Step For Loop: First even number should be "2"');
            assertEqual(outputs[1], '4', 'Positive Step For Loop: Second even number should be "4"');
            assertEqual(outputs[4], '10', 'Positive Step For Loop: Final even number should be "10"');
        }
        
        /**
         * Test for loops with negative step values
         */
        function testForLoopWithNegativeStep() {
            const outputs = executeAndGetOutputs(`
                for i = 10 to 0 step -1
                    print(str(i))
                next i
            `);
            
            assertEqual(outputs.length, 11, 'Negative Step For Loop: Should have 11 outputs for countdown');
            assertEqual(outputs[0], '10', 'Negative Step For Loop: Countdown should start with "10"');
            assertEqual(outputs[10], '0', 'Negative Step For Loop: Countdown should end with "0"');
        }
        
        /**
         * Test switch/case statements
         */
        function testSwitchCase() {
            const outputs = executeAndGetOutputs(`
                day = "Mon"
                switch day:
                case "Mon":
                    print("Monday")
                case "Tue":
                    print("Tuesday")
                default:
                    print("Unknown day")
                endswitch
                print("Done")
            `);
            
            assertEqual(executeAndGetVariable(`
                day = "Mon"
                switch day:
                case "Mon":
                    result = "Monday"
                case "Tue":
                    result = "Tuesday"
                default:
                    result = "Unknown day"
                endswitch
            `, 'day'), 'Mon', 'day should be "Mon"');
            
            assertEqual(outputs.length, 2, 'Should have exactly 2 outputs');
            assertEqual(outputs[0], 'Monday', 'First output should be "Monday"');
            assertEqual(outputs[1], 'Done', 'Second output should be "Done"');
        }
        
        /**
         * Test error handling and reserved keywords
         */
        function testErrorHandling() {
            // Test reserved keyword usage
            try {
                const interpreter = new Interpreter();
                interpreter.executeProgram('if = 5');
                assert(false, 'Reserved Keyword Error', 'Should have thrown error for using "if" as variable');
            } catch (error) {
                assert(error.message.includes('reserved keyword'), 'Reserved Keyword Error', 'Correctly caught reserved keyword usage');
            }
            
            // Test constant reassignment
            try {
                const interpreter = new Interpreter();
                interpreter.executeProgram(`
                    const PI = 3.14159
                    PI = 2.71828
                `);
                assert(false, 'Constant Reassignment Error', 'Should have thrown error for reassigning constant');
            } catch (error) {
                assert(error.message.includes('Cannot reassign constant'), 'Constant Reassignment Error', 'Correctly caught constant reassignment');
            }
        }
        
        /**
         * Test array functionality
         */
        function testArrayFunctionality() {
            // Test array declaration with size
            const result1 = executeAndGetVariables(`
                array colours[3]
                colours[0] = "Red"
                colours[1] = "Blue"
                colours[2] = "Green"
            `);
            
            assertEqual(result1.colours[0], 'Red', 'colours[0] should be "Red"');
            assertEqual(result1.colours[1], 'Blue', 'colours[1] should be "Blue"');
            assertEqual(result1.colours[2], 'Green', 'colours[2] should be "Green"');
            
            // Test array initialization with values
            const result2 = executeAndGetVariables(`
                array scores = [85, 92, 78, 90]
                highest = scores[1]
            `);
            
            assertEqual(result2.scores[0], 85, 'scores[0] should be 85');
            assertEqual(result2.scores[1], 92, 'scores[1] should be 92');
            assertEqual(result2.scores[2], 78, 'scores[2] should be 78');
            assertEqual(result2.scores[3], 90, 'scores[3] should be 90');
            assertEqual(result2.highest, 92, 'highest should be 92 (scores[1])');
            
            // Test array access with variables
            const result3 = executeAndGetVariables(`
                array names = ["Alice", "Bob", "Charlie"]
                index = 1
                current_name = names[index]
            `);
            
            assertEqual(result3.names[1], 'Bob', 'names[1] should be "Bob"');
            assertEqual(result3.index, 1, 'index should be 1');
            assertEqual(result3.current_name, 'Bob', 'current_name should be "Bob"');
        }
        
        /**
         * Test complex programs combining multiple features
         */
        function testComplexPrograms() {
            // Test factorial calculation
            assertEqual(executeAndGetVariable(`
                n = 5
                factorial = 1
                for i = 1 to n
                    factorial = factorial * i
                next i
            `, 'factorial'), 120, 'Factorial Calculation (5! = 120)');
            
            // Test string processing
            const outputs = executeAndGetOutputs(`
                text = "Hello World"
                print("Original: " + text)
                print("Length: " + str(text.length))
                print("Upper: " + text.upper())
                print("First 5: " + text.left(5))
            `);
            assertArrayEqual(outputs, [
                "Original: Hello World",
                "Length: 11",
                "Upper: HELLO WORLD",
                "First 5: Hello"
            ], 'String Processing Program');
        }
        
        /**
         * Test interpreter state management
         */
        function testInterpreterStateManagement() {
            const testInterpreter = new Interpreter();
            
            // Test initial state
            assertEqual(Object.keys(testInterpreter.variables).length, 0, 'Initial State: Should start with no variables');
            assertEqual(testInterpreter.outputs.length, 0, 'Initial State: Should start with no outputs');
            
            // Execute some code and verify state changes
            testInterpreter.executeProgram(`
                x = 10
                y = 20
                print("Hello")
            `);
            
            assertEqual(testInterpreter.variables.x, 10, 'After Execution: Should have variable x');
            assertEqual(testInterpreter.variables.y, 20, 'After Execution: Should have variable y');
            assertEqual(testInterpreter.outputs.length, 1, 'After Execution: Should have one output');
            
            // Reset and verify clean state
            testInterpreter.reset();
            
            assertEqual(Object.keys(testInterpreter.variables).length, 0, 'After Reset: Should have no variables');
            assertEqual(testInterpreter.outputs.length, 0, 'After Reset: Should have no outputs');
            
            // Execute different code after reset
            testInterpreter.executeProgram(`
                a = 100
                print("World")
            `);
            
            assertEqual(testInterpreter.variables.a, 100, 'After Reset Execute: Should have new variable a');
            assert(!testInterpreter.variables.hasOwnProperty('x'), 'After Reset Execute: Should not have old variable x');
            assert(!testInterpreter.variables.hasOwnProperty('y'), 'After Reset Execute: Should not have old variable y');
            assertEqual(testInterpreter.outputs[0], "World", 'After Reset Execute: Should have new output');
        }
        
        // TEST MANAGEMENT AND EXECUTION
        // ============================================================================
        
        /**
         * Reset test state for a fresh test run
         */
        function resetTestState() {
            testResults = [];
            testsPassed = 0;
            testsFailed = 0;
        }
        
        /**
         * Display comprehensive test summary
         */
        function displayTestSummary() {
            const summaryDiv = document.getElementById('testSummary');
            const passRate = testsPassed + testsFailed > 0 ? 
                Math.round((testsPassed / (testsPassed + testsFailed)) * 100) : 0;
            
            summaryDiv.innerHTML = `
                <div class="test-summary ${passRate === 100 ? 'all-pass' : 'has-failures'}">
                    <h2>üìä Unit Test Results</h2>
                    <p><strong>Passed:</strong> ${testsPassed} | <strong>Failed:</strong> ${testsFailed} | <strong>Pass Rate:</strong> ${passRate}%</p>
                    <p><em>Testing individual interpreter methods and language features</em></p>
                </div>
            `;
        }
        
        /**
         * Display categorized test results
         */
        function displayTestResults() {
            const resultsDiv = document.getElementById('testResults');
            
            // Group tests by category
            const testCategories = {
                'Basic Arithmetic': ['Basic Addition', 'Basic Subtraction', 'Basic Multiplication', 'Basic Division', 'Basic Modulo', 'Basic Integer Division', 'Basic Exponentiation'],
                'Operator Precedence': ['Multiplication before Addition', 'Division before Subtraction', 'Exponentiation before Multiplication', 'Left-to-right'],
                'Parentheses': ['Basic Parentheses', 'Nested Parentheses', 'Rectangle Perimeter', 'Complex Parentheses'],
                'Array Access': ['Array Access with Variable Index', 'Array Access with Literal Index', 'Arithmetic with Array Access', 'Array Access in Multiplication'],
                'Array Functionality': ['colours[0] should be', 'colours[1] should be', 'colours[2] should be', 'scores[0] should be', 'scores[1] should be', 'scores[2] should be', 'scores[3] should be', 'highest should be', 'names[1] should be', 'index should be', 'current_name should be'],
                'String Methods': ['First name .left(1)', 'Last name .left(1)', 'Initials concatenation', 'String .upper method', 'String .lower method'],
                'ASCII Functions': ['ASC("A")', 'ASC("Z")', 'ASC("a")', 'ASC("0")', 'ASC(" ")', 'ASC(letter)', 'CHR(65)', 'CHR(90)', 'CHR(97)', 'CHR(48)', 'CHR(32)', 'CHR(ascii_val)'],
                'Boolean Operators': ['AND: Both conditions true', 'AND: First false', 'AND: Second false', 'OR: First true', 'OR: Second true', 'OR: Both false', 'ASCII range check with AND'],
                'For Loop Execution': ['x should be 2', 'Should have exactly 3 outputs', 'First output should be "0"', 'Second output should be "2"', 'Third output should be "4"'],
                'Variable Operations': ['Variable Access', 'Numeric Literal'],
                'Complex Expressions': ['Complex Expression', 'Multiple Operators'],
                'Edge Cases': ['Division by One', 'Multiplication by Zero', 'Power of Zero', 'Empty Array Access', 'Out of Bounds Array Access'],
                'Type Conversions': ['float(', 'int(', 'str(', 'bool('],
                'Nested Conditionals': ['Nested If', 'MOD in For Loop'],
                'String Methods in Print': ['String Methods in Print'],
                'Substring with Variable': ['Substring with Variable'],
                'Comments': ['despite comments', 'z should be 15'],
                'Constants': ['const pi', 'const vat', 'total should be 120'],
                'For Loops with Step': ['Positive Step For Loop', 'Negative Step For Loop'],
                'Switch/Case': ['day should be "Mon"', 'First output should be "Monday"', 'Second output should be "Done"'],
                'Error Handling': ['Reserved Keyword Error', 'Constant Reassignment Error'],
                'Complex Programs': ['Factorial Calculation', 'String Processing Program'],
                'State Management': ['Initial State', 'After Execution', 'After Reset', 'After Reset Execute']
            };
            
            let html = '';
            
            // Track which tests have been categorized
            const categorizedTests = new Set();
            
            for (const [categoryName, prefixes] of Object.entries(testCategories)) {
                const categoryTests = testResults.filter(test => 
                    prefixes.some(prefix => test.name.includes(prefix))
                );
                
                if (categoryTests.length > 0) {
                    html += `<div class="test-section">`;
                    html += `<h2>${categoryName}</h2>`;
                    
                    for (const test of categoryTests) {
                        categorizedTests.add(test.name); // Track categorized tests
                        const cssClass = test.passed ? 'test-pass' : 'test-fail';
                        const status = test.passed ? '‚úÖ PASS' : '‚ùå FAIL';
                        html += `<div class="test-result ${cssClass}">`;
                        html += `<strong>${status}</strong> - ${test.name}`;
                        if (test.details) {
                            html += `<div class="test-details">${test.details}</div>`;
                        }
                        html += `</div>`;
                    }
                    
                    html += `</div>`;
                }
            }
            
            // Add uncategorized tests section
            const uncategorizedTests = testResults.filter(test => !categorizedTests.has(test.name));
            if (uncategorizedTests.length > 0) {
                html += `<div class="test-section">`;
                html += `<h2>‚ö†Ô∏è Uncategorized Tests (${uncategorizedTests.length})</h2>`;
                
                for (const test of uncategorizedTests) {
                    const cssClass = test.passed ? 'test-pass' : 'test-fail';
                    const status = test.passed ? '‚úÖ PASS' : '‚ùå FAIL';
                    html += `<div class="test-result ${cssClass}">`;
                    html += `<strong>${status}</strong> - ${test.name}`;
                    if (test.details) {
                        html += `<div class="test-details">${test.details}</div>`;
                    }
                    html += `</div>`;
                }
                
                html += `</div>`;
            }
            
            resultsDiv.innerHTML = html;
            
            // Default to hiding passed tests
            const container = document.querySelector('.container');
            const toggleBtn = document.getElementById('togglePassedBtn');
            
            container.classList.add('hide-passed');
            const passedCount = document.querySelectorAll('.test-result.test-pass').length;
            toggleBtn.textContent = `üëÅÔ∏è Show Passed Tests (${passedCount} hidden)`;
            toggleBtn.classList.add('active');
            
            displayTestSummary();
        }
        
        /**
         * Toggle visibility of passed tests
         */
        function togglePassedTests() {
            const container = document.querySelector('.container');
            const toggleBtn = document.getElementById('togglePassedBtn');
            const passedCount = document.querySelectorAll('.test-result.test-pass').length;
            
            if (container.classList.contains('hide-passed')) {
                container.classList.remove('hide-passed');
                toggleBtn.textContent = 'üôà Hide Passed Tests';
                toggleBtn.classList.remove('active');
            } else {
                container.classList.add('hide-passed');
                toggleBtn.textContent = `üëÅÔ∏è Show Passed Tests (${passedCount} hidden)`;
                toggleBtn.classList.add('active');
            }
        }
        
        /**
         * Set up keyboard shortcuts for test management
         */
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(event) {
                if (event.key === 'h' || event.key === 'H') {
                    togglePassedTests();
                } else if (event.key === 'r' || event.key === 'R') {
                    runAllTests();
                }
            });
        }
        
        /**
         * Run all unit tests
         */
        function runAllTests() {
            // Reset state
            resetTestState();
            
            // Run all test categories
            testBasicArithmetic();
            testOperatorPrecedence();
            testParentheses();
            testArrayAccess();
            testArrayFunctionality();
            testStringMethods();
            testASCAndCHRFunctions();
            testBooleanOperators();
            testForLoopExecution();
            testVariableOperations();
            testComplexExpressions();
            testEdgeCases();
            testTypeConversions();
            testNestedConditionalExecution();
            testStringMethodsInPrint();
            testSubstringWithVariable();
            testComments();
            testConstants();
            testForLoopWithPositiveStep();
            testForLoopWithNegativeStep();
            testSwitchCase();
            testErrorHandling();
            testComplexPrograms();
            testInterpreterStateManagement();
            
            // Display results
            displayTestResults();
            
            console.log(`‚úÖ Unit tests completed: ${testsPassed} passed, ${testsFailed} failed`);
        }
        
        // Make functions available globally
        window.runAllTests = runAllTests;
        window.togglePassedTests = togglePassedTests;
        
        // Auto-run tests on page load
        document.addEventListener('DOMContentLoaded', function() {
            setupKeyboardShortcuts();
            runAllTests();
        });
    </script>
</body>
</html>